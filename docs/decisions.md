# 技术决策记录 (ADR)

## ADR-001: 选择图像生成模型（SDXL）而非 LLM/多模态模型

### 状态
✅ 已接受

### 背景
项目目标是根据文本描述生成技术项目 Logo。可选的技术路线包括：
1. **图像生成模型**（SDXL + LoRA）→ 生成 PNG → 工具转 SVG
2. **大语言模型**（LLaMA/Qwen）→ 直接输出 SVG 代码
3. **多模态模型**（GPT-4V/Qwen-VL）→ 理解概念 → 输出 SVG 代码

### 决策
**选择方案 1：基于 SDXL 图像生成模型的微调方案**

### 原因

#### 1. 任务本质匹配度

| 维度 | 图像生成 | 文本生成 |
|------|---------|---------|
| **训练目标** | 学习"文本描述 → 视觉特征" | 学习"文本描述 → 代码结构" |
| **输出质量** | 高（扩散模型擅长生成视觉内容） | 低（LLM 不擅长精确几何图形） |
| **工具链成熟度** | kohya-ss、Diffusers 等完善 | 无现成 LoRA 工具支持 SVG 代码生成 |

**关键洞察**：
Logo 设计是**视觉创作任务**，不是**编程任务**。扩散模型在像素级别的生成质量远超 LLM 在代码级别的几何描述能力。

#### 2. SVG 直接生成的技术障碍

尝试让 LLM/多模态模型直接生成 SVG 会面临：

**语法准确性问题**（即使 GPT-4 也有 10-20% 错误率）：
```svg
<!-- 错误示例：模型可能输出 -->
<path d="M10 10 L90 90 L10 90"        <!-- 引号未闭合 -->
<circle cx="50" cy="50" r=""/>        <!-- r 属性为空 -->
```

**几何合理性問題**（更难检测）：
```svg
<!-- 模型可能输出语法正确但几何错误的 SVG -->
<path d="M999 999 L-100 -100 Z"/>      <!-- 坐标超出 viewBox -->
```

**结论**：LLM 生成结构化代码需要额外的验证/修复步骤，增加了系统复杂度。

#### 3. 数据准备成本

**方案 1（SDXL）数据流**：
```
Simple Icons (SVG)
    ↓ 脚本自动转换
PNG 图片 (512x512)
    ↓ 脚本自动生成
标注文件 (.txt)
    ↓ 开始训练
SDXL LoRA
```
- 全自动，无需人工干预
- 数据格式标准化

**方案 2/3（LLM/多模态）数据流**：
```
Simple Icons (SVG)
    ↓ 需要构造对话数据
{ "prompt": "React logo", "svg": "<svg>...</svg>" }
    ↓ 需要人工检查/清洗
训练数据
    ↓ 自行实现训练代码
微调模型
```
- 需要额外的数据格式转换
- 缺乏成熟的训练工具支持
- 需要验证 SVG 语法正确性

#### 4. 推理阶段对比

| 指标 | SDXL + potrace | LLM 直接生成 SVG |
|------|---------------|------------------|
| 生成速度 | 2-3 秒 | 5-10 秒（LLM 生成文本较慢）|
| 输出质量 | 高（扩散模型擅长图像） | 中（几何细节容易出错）|
| 可编辑性 | SVG 可编辑 | SVG 可编辑 |
| 失败率 | <1% | 10-20%（需重试机制）|

### 被否决的方案

#### ❌ 方案 2：LLM 直接生成 SVG
- 否决原因：LLM 生成结构化代码准确性低，无现成训练工具

#### ❌ 方案 3：多模态模型生成 SVG
- 否决原因：
  - 训练成本极高（需 24GB+ 显存，训练数天）
  - 输出不稳定（SVG 代码容易出错）
  - 杀鸡用牛刀（多模态能力在此场景无优势）

### 结论

**图像生成模型（SDXL）更适合此任务**，因为：
1. Logo 生成是视觉任务，扩散模型在此领域最成熟
2. PNG→SVG 的工具链（potrace）比训练模型输出代码更可靠
3. 数据准备、训练、部署的全链路工具完善

---

## ADR-002: 选择 PNG 作为中间格式而非直接生成 SVG

### 状态
✅ 已接受

### 背景
即使选择了图像生成模型，仍存在一个问题：
- 训练数据 Simple Icons 是 SVG 格式
- 最终输出也可以是 SVG 格式
- **为什么不训练模型直接"理解"SVG 并生成 SVG？**

### 决策
**将 SVG 转换为 PNG 进行训练，推理时生成 PNG，再按需转换为 SVG**

### 原因

#### 1. 模型架构限制

**SDXL 的本质**：
```python
# SDXL 的输入输出
输入: text_embedding (文本向量)
输出: latent_image (图像潜在空间表示)
      ↓ 解码器
      pixel_tensor (像素张量 [B, 3, H, W])
```

SDXL 是**像素空间生成模型**，其神经网络架构（U-Net + VAE）专门设计用于生成像素数据。它**无法直接输出文本或 SVG 代码**。

#### 2. 向量化 vs 光栅化的权衡

| 特性 | 光栅化 (PNG) | 矢量化 (SVG) |
|------|-------------|-------------|
| **缩放** | 会失真 | 无限缩放 |
| **文件大小** | 较大（固定分辨率） | 较小（数学描述）|
| **编辑性** | 难编辑 | 易编辑 |
| **生成难度** | 扩散模型擅长 | LLM 不擅长 |

**决策逻辑**：
```
用户需要可缩放的 Logo (SVG)
         ↓
但扩散模型只能生成像素 (PNG)
         ↓
使用工具 (potrace) 将 PNG 转为 SVG
         ↓
两全其美：生成质量高 + 最终格式可编辑
```

#### 3. 工具链成熟度

**potrace**（PNG→SVG 转换工具）：
- 25 年历史，算法成熟
- 100% 成功率（只要输入图片清晰）
- 命令行工具，易于集成

**对比**：训练 LLM 生成 SVG 代码
- 需要大量数据
- 输出不稳定
- 需要语法验证

### 被否决的方案

#### ❌ 尝试修改 SDXL 输出 SVG
- 否决原因：需要重写模型架构，工作量巨大，失去使用成熟模型的意义

#### ❌ 跳过 PNG 直接端到端 SVG
- 否决原因：无成熟技术方案，需自行研发多模态模型

### 结论

**PNG 作为中间格式是技术现实与需求之间的最优平衡点**：
1. SDXL 生成 PNG 是成熟技术路线
2. potrace 转换 PNG→SVG 可靠且快速
3. 用户体验：先生成预览（PNG），满意后再导出 SVG

---

## ADR-003: 选择 Simple Icons 作为主要数据源

### 状态
✅ 已接受

### 背景
初始计划从 GitHub Trending/Most Starred 仓库获取 logo，但遇到：
1. GitHub API 速率限制严格
2. 仓库 logo 位置不统一，获取困难
3. 风格差异大，筛选成本高

### 决策
**改用 Simple Icons 作为核心训练数据源**

### 原因

#### 1. 数据质量

| 特性 | GitHub Repos | Simple Icons |
|------|-------------|--------------|
| **数量** | 不稳定（需爬虫）| 3400+ 稳定提供 |
| **风格一致性** | 差异大（照片、插画、文字） | 100% 极简单色 |
| **格式** | PNG/JPG/SVG 混杂 | 100% SVG |
| **授权** | 各异 | 100% CC0 |
| **标注** | 无 | 自带 title/slug/hex |

#### 2. 与项目定位匹配

项目定位是 **"极简风格 Logo 生成器"**，Simple Icons：
- ✅ 全部是单色、几何、极简风格
- ✅ 覆盖技术品牌（React, Vue, Docker, Kubernetes...）
- ✅ 用户期望输出就是这种风格

GitHub 仓库 logo：
- ❌ 包含照片、复杂插画
- ❌ 很多只是项目截图，不是 logo
- ❌ 需要大量筛选工作

#### 3. 数据准备效率

**Simple Icons**（今天完成）：
- 1 个脚本下载全部元数据
- 1 个脚本下载全部 SVG
- 1 个脚本批量转换 PNG
- 自动标注生成

**GitHub Repos**（预估）：
- 爬虫绕过 API 限制
- 图像识别筛选极简风格
- 人工检查确认
- 手动标注

时间成本：Simple Icons **1 天** vs GitHub **1-2 周**

### 补充说明

**GitHub 数据并未完全放弃**：
- 可以作为后续补充数据源
- 用于验证模型在真实项目 logo 上的泛化能力

### 结论

**Simple Icons 是 MVP 阶段的最佳选择**：
1. 数据质量高、风格统一
2. 3400+ 数量足够训练
3. 全自动数据准备，零人工成本

---

## 决策总结

| 决策 | 选择 | 核心原因 |
|------|------|---------|
| 模型类型 | SDXL LoRA | 视觉任务用视觉模型，工具链成熟 |
| 中间格式 | PNG | SDXL 架构限制，potrace 转换可靠 |
| 数据源 | Simple Icons | 风格统一、数据干净、全自动处理 |

这三个决策相互支撑，构成了**可行性强、质量有保障**的技术方案。
